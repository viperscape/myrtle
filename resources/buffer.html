<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Buffer</title>
  <style type="text/css" media="screen">
    body {
        /*overflow: hidden;*/
        background-color: #000;
    }
    #editor { 
        
        position:fixed;
        width:100%;
        left:0;
        top: 5%;
        /*
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        position: absolute;
        */
        height:67%;
    }

    #console{
      background: #000;
      height: 28%;
      width: 100%;
      left:4px;
      position: fixed;
      bottom:0;
      color:#333;
    }

    #completions{
      background:#333;
      height: auto;
      width: 33%;
      left:0;
      position: relative;
      top:0;
      color:#000;
      display:none;
      z-index: 99;
    }

    .ace_scrollbar {
    display: none !important;
    }
  </style>


</head>
<body>

<script>


var wrap = true;
function toggleWrap(){
  if (wrap) {
    wrap=false;
    document.getElementById("bwrap").style.backgroundColor = "#FCFCFC";
    document.getElementById("bwrap").style.borderStyle = "outset";
  }else {
    wrap=true;
    document.getElementById("bwrap").style.backgroundColor = "#666";
    document.getElementById("bwrap").style.borderStyle = "inset";
  }

  editor.getSession().setUseWrapMode(wrap);
}
</script>

<input type="button" id="bwrap" value="wrap" onmousedown="toggleWrap();" style="border-style:inset;background-color:#666;" />
<input type="button" id="beval" value="eval" onmousedown="evalRepl(editor);" style="" />

<div id="editor" onkeydown="document.getElementById('completions').style.display = 'none';"><!--editor for code--></div>
<div id="completions"></div>


<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script> 

<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.setFontSize("16px");
    editor.setShowPrintMargin(false);
    editor.getSession().setMode("ace/mode/clojure");
    editor.getSession().setUseWrapMode(true);
    document.getElementById("editor").appendChild(document.getElementById("completions"));
</script>

<script>
    var buffer = false;

function updateConsole (txt){
  console.insert(txt+"\r\n");
  //document.getElementById("console").innerHTML += "<br>"+txt;
}

/*annotate
  editor.getSession().setAnnotations([{
  row: 1,
  column: 10,
  text: "Strange error",
  type: "error" // also warning and information
}]);*/

function emptyline(buff){
  buff.selectMore(-1,true);
  if (buff.session.getTextRange(buff.getSelectionRange()) == ""){
    buff.selectMore(1,true);
    if (buff.session.getTextRange(buff.getSelectionRange()) == ""){
      return true;
    }}

  return false;
}

function evalRepl (buff) {
 if (buffer){

  var txt = buff.session.getTextRange(buff.getSelectionRange());
//alert(emptyline(buff) + ";"+buff.getSelectionRange());
  if (txt){
    updateConsole("=> "+txt);
    socket.send(JSON.stringify({"repl":{"eval":txt,"buffer":buffer}}));
  }
 }
}

function Complete(f){
  editor.selectMore(-1,true);
  editor.insert(f);
  editor.navigateWordRight();
  document.getElementById("completions").style.display = "none";
  editor.focus();
}

   
    var jconsole = {"buffer": {"open": ""}}; //{"open": "buff5308"}};
    var socket = new WebSocket("ws://localhost");
    socket.onopen = function(){
      updateConsole("@ws:"+JSON.stringify(jconsole));
      socket.send(JSON.stringify(jconsole));
        }
    socket.onmessage = function(m){
      //var jd = eval('(' + m.data + ')'); //gasp
      var jd = JSON.parse(m.data);
      updateConsole("&ws:"+JSON.stringify(jd));
        if (jd.repl){
          jd.repl.forEach(function(e){
            var n = JSON.parse(e);
            updateConsole(n.ns + " > " + n.value);
          });
        }
        if (jd.console){
            updateConsole(jd.console);
        }
        if (jd.buffer){
          buffer = jd.buffer;
        }
        if ((jd.completions) && (jd.completions != "nil")) {
          updateConsole(" * "+jd.completions+" * ");
          //editor.navigateWordLeft();
          var cx = editor.renderer.$cursorLayer.getPixelPosition().left + 60;
          var cy = editor.renderer.$cursorLayer.getPixelPosition().top + 30;
          var carr = [];
          jd.completions.forEach(function(e){carr.push("<a href='#' onmousedown='Complete(\""+e+"\");'>"+e+"</a>")});

          document.getElementById("completions").innerHTML = carr;
          //completions.setValue(jd.completions);
          document.getElementById("completions").style.display = "inherit";
          document.getElementById("completions").style.left = cx+"px";
          document.getElementById("completions").style.top = cy+"px";

          }
        if (jd.buff){alert(jd.buff);}
    }
    socket.onerror = function(e){
      alert("error, connection lost");  
        }



editor.commands.addCommand({
    name: 'Eval',
    bindKey: {win: 'Ctrl-Enter',  mac: 'Command-Return'},
    exec: function (editor) {evalRepl(editor)},
    readOnly: true // false if this command should not apply in readOnly mode
});

editor.commands.addCommand({
    name: 'Completions',
    bindKey: {win: 'Tab',  mac: 'Tab'},
    exec: function (editor) {
      editor.selectMore(-1,true);
      var txt = editor.session.getTextRange(editor.getSelectionRange());
      editor.navigateWordRight(); //clear selection, move cursor back
      //editor.indent();
      if (txt.match(/\S/g)) {socket.send(JSON.stringify({"completions":txt}));}
      else {editor.indent();}
    },
    readOnly: false // false if this command should not apply in readOnly mode
});

</script>


<div id="console"><!--console for printed repl--></div>
<script>
    var console = ace.edit("console");
    console.setTheme("ace/theme/monokai");
    console.setFontSize("14px");
    console.setShowPrintMargin(false);
    console.renderer.setShowGutter(false);
    console.getSession().setMode("ace/mode/clojure");
    console.getSession().setUseWrapMode(true);
    console.setReadOnly(true); 

    /*var completions = ace.edit("completions");
    completions.setTheme("ace/theme/monokai");
    completions.getSession().setMode("ace/mode/clojure");
    completions.getSession().setUseWrapMode(true);
    completions.setReadOnly(true); */
</script>

</body>
</html>
